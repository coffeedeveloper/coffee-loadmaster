(function(global,factory){typeof exports==="object"&&typeof module!=="undefined"?module.exports=factory():typeof define==="function"&&define.amd?define(factory):global.LoadMaster=factory()})(this,function(){"use strict";var domain;function EventHandlers(){}EventHandlers.prototype=Object.create(null);function EventEmitter(){EventEmitter.init.call(this)}EventEmitter.usingDomains=false;EventEmitter.prototype.domain=undefined;EventEmitter.prototype._events=undefined;EventEmitter.prototype._maxListeners=undefined;EventEmitter.defaultMaxListeners=10;EventEmitter.init=function(){this.domain=null;if(EventEmitter.usingDomains){if(domain.active&&!(this instanceof domain.Domain)){this.domain=domain.active}}if(!this._events||this._events===Object.getPrototypeOf(this)._events){this._events=new EventHandlers;this._eventsCount=0}this._maxListeners=this._maxListeners||undefined};EventEmitter.prototype.setMaxListeners=function setMaxListeners(n){if(typeof n!=="number"||n<0||isNaN(n)){throw new TypeError('"n" argument must be a positive number')}this._maxListeners=n;return this};function $getMaxListeners(that){if(that._maxListeners===undefined){return EventEmitter.defaultMaxListeners}return that._maxListeners}EventEmitter.prototype.getMaxListeners=function getMaxListeners(){return $getMaxListeners(this)};function emitNone(handler,isFn,self){if(isFn){handler.call(self)}else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].call(self)}}}function emitOne(handler,isFn,self,arg1){if(isFn){handler.call(self,arg1)}else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].call(self,arg1)}}}function emitTwo(handler,isFn,self,arg1,arg2){if(isFn){handler.call(self,arg1,arg2)}else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].call(self,arg1,arg2)}}}function emitThree(handler,isFn,self,arg1,arg2,arg3){if(isFn){handler.call(self,arg1,arg2,arg3)}else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].call(self,arg1,arg2,arg3)}}}function emitMany(handler,isFn,self,args){if(isFn){handler.apply(self,args)}else{var len=handler.length;var listeners=arrayClone(handler,len);for(var i=0;i<len;++i){listeners[i].apply(self,args)}}}EventEmitter.prototype.emit=function emit(type){var arguments$1=arguments;var er,handler,len,args,i,events,domain;var needDomainExit=false;var doError=type==="error";events=this._events;if(events){doError=doError&&events.error==null}else if(!doError){return false}domain=this.domain;if(doError){er=arguments[1];if(domain){if(!er){er=new Error('Uncaught, unspecified "error" event')}er.domainEmitter=this;er.domain=domain;er.domainThrown=false;domain.emit("error",er)}else if(er instanceof Error){throw er}else{var err=new Error('Uncaught, unspecified "error" event. ('+er+")");err.context=er;throw err}return false}handler=events[type];if(!handler){return false}var isFn=typeof handler==="function";len=arguments.length;switch(len){case 1:emitNone(handler,isFn,this);break;case 2:emitOne(handler,isFn,this,arguments[1]);break;case 3:emitTwo(handler,isFn,this,arguments[1],arguments[2]);break;case 4:emitThree(handler,isFn,this,arguments[1],arguments[2],arguments[3]);break;default:args=new Array(len-1);for(i=1;i<len;i++){args[i-1]=arguments$1[i]}emitMany(handler,isFn,this,args)}if(needDomainExit){domain.exit()}return true};function _addListener(target,type,listener,prepend){var m;var events;var existing;if(typeof listener!=="function"){throw new TypeError('"listener" argument must be a function')}events=target._events;if(!events){events=target._events=new EventHandlers;target._eventsCount=0}else{if(events.newListener){target.emit("newListener",type,listener.listener?listener.listener:listener);events=target._events}existing=events[type]}if(!existing){existing=events[type]=listener;++target._eventsCount}else{if(typeof existing==="function"){existing=events[type]=prepend?[listener,existing]:[existing,listener]}else{if(prepend){existing.unshift(listener)}else{existing.push(listener)}}if(!existing.warned){m=$getMaxListeners(target);if(m&&m>0&&existing.length>m){existing.warned=true;var w=new Error("Possible EventEmitter memory leak detected. "+existing.length+" "+type+" listeners added. "+"Use emitter.setMaxListeners() to increase limit");w.name="MaxListenersExceededWarning";w.emitter=target;w.type=type;w.count=existing.length;emitWarning(w)}}}return target}function emitWarning(e){typeof console.warn==="function"?console.warn(e):console.log(e)}EventEmitter.prototype.addListener=function addListener(type,listener){return _addListener(this,type,listener,false)};EventEmitter.prototype.on=EventEmitter.prototype.addListener;EventEmitter.prototype.prependListener=function prependListener(type,listener){return _addListener(this,type,listener,true)};function _onceWrap(target,type,listener){var fired=false;function g(){target.removeListener(type,g);if(!fired){fired=true;listener.apply(target,arguments)}}g.listener=listener;return g}EventEmitter.prototype.once=function once(type,listener){if(typeof listener!=="function"){throw new TypeError('"listener" argument must be a function')}this.on(type,_onceWrap(this,type,listener));return this};EventEmitter.prototype.prependOnceListener=function prependOnceListener(type,listener){if(typeof listener!=="function"){throw new TypeError('"listener" argument must be a function')}this.prependListener(type,_onceWrap(this,type,listener));return this};EventEmitter.prototype.removeListener=function removeListener(type,listener){var list,events,position,i,originalListener;if(typeof listener!=="function"){throw new TypeError('"listener" argument must be a function')}events=this._events;if(!events){return this}list=events[type];if(!list){return this}if(list===listener||list.listener&&list.listener===listener){if(--this._eventsCount===0){this._events=new EventHandlers}else{delete events[type];if(events.removeListener){this.emit("removeListener",type,list.listener||listener)}}}else if(typeof list!=="function"){position=-1;for(i=list.length;i-- >0;){if(list[i]===listener||list[i].listener&&list[i].listener===listener){originalListener=list[i].listener;position=i;break}}if(position<0){return this}if(list.length===1){list[0]=undefined;if(--this._eventsCount===0){this._events=new EventHandlers;return this}else{delete events[type]}}else{spliceOne(list,position)}if(events.removeListener){this.emit("removeListener",type,originalListener||listener)}}return this};EventEmitter.prototype.removeAllListeners=function removeAllListeners(type){var this$1=this;var listeners,events;events=this._events;if(!events){return this}if(!events.removeListener){if(arguments.length===0){this._events=new EventHandlers;this._eventsCount=0}else if(events[type]){if(--this._eventsCount===0){this._events=new EventHandlers}else{delete events[type]}}return this}if(arguments.length===0){var keys=Object.keys(events);for(var i=0,key;i<keys.length;++i){key=keys[i];if(key==="removeListener"){continue}this$1.removeAllListeners(key)}this.removeAllListeners("removeListener");this._events=new EventHandlers;this._eventsCount=0;return this}listeners=events[type];if(typeof listeners==="function"){this.removeListener(type,listeners)}else if(listeners){do{this$1.removeListener(type,listeners[listeners.length-1])}while(listeners[0])}return this};EventEmitter.prototype.listeners=function listeners(type){var evlistener;var ret;var events=this._events;if(!events){ret=[]}else{evlistener=events[type];if(!evlistener){ret=[]}else if(typeof evlistener==="function"){ret=[evlistener.listener||evlistener]}else{ret=unwrapListeners(evlistener)}}return ret};EventEmitter.listenerCount=function(emitter,type){if(typeof emitter.listenerCount==="function"){return emitter.listenerCount(type)}else{return listenerCount.call(emitter,type)}};EventEmitter.prototype.listenerCount=listenerCount;function listenerCount(type){var events=this._events;if(events){var evlistener=events[type];if(typeof evlistener==="function"){return 1}else if(evlistener){return evlistener.length}}return 0}EventEmitter.prototype.eventNames=function eventNames(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};function spliceOne(list,index){for(var i=index,k=i+1,n=list.length;k<n;i+=1,k+=1){list[i]=list[k]}list.pop()}function arrayClone(arr,i){var copy=new Array(i);while(i--){copy[i]=arr[i]}return copy}function unwrapListeners(arr){var ret=new Array(arr.length);for(var i=0;i<ret.length;++i){ret[i]=arr[i].listener||arr[i]}return ret}var defaults={container:window,threshold:window.innerHeight,offset:window.innerHeight,trigger:["above","curr","below"],event:"scroll",items:null,optimize:true};var each=function(arr,cb){var len=arr.length;var r=[];for(var i=0;i<len;i++){r.push(cb(arr[i],i))}return r};var extend=function(target){var arguments$1=arguments;for(var i=1;i<arguments.length;i++){var arg=arguments$1[i];for(var p in arg){target[p]=arg[p]}}return target};var calc=function(el){var rect=el.getBoundingClientRect();return{el:el,bottom:rect.top+document.body.scrollTop+el.offsetHeight,height:el.offsetHeight,top:rect.top+document.body.scrollTop,left:rect.left+document.body.scrollLeft}};var LoadMaster=function(EventEmitter$$1){function LoadMaster(options){var this$1=this;EventEmitter$$1.call(this);this.opts=extend({},defaults,options);this.container=typeof this.opts.container=="string"?document.querySelector(this.opts.container):this.opts.container;this.isWindowContainer=this.container===window;var currTop=document.body.scrollTop;if(!this.isWindowContainer){!options.threshold&&(this.opts.threshold=this.container.offsetHeight);!options.offset&&(this.opts.offset=this.container.offsetHeight);currTop=this.container.scrollTop}this.on("newListener",function(event,listener){if(event=="curr"){setTimeout(function(){this$1.curr(currTop,undefined)},0)}});this._meta();this.bind()}if(EventEmitter$$1)LoadMaster.__proto__=EventEmitter$$1;LoadMaster.prototype=Object.create(EventEmitter$$1&&EventEmitter$$1.prototype);LoadMaster.prototype.constructor=LoadMaster;LoadMaster.calc=function calc$1(eles){if(typeof eles=="string"){eles=document.querySelectorAll(eles)}var r;if(eles.length){r=each(eles,function(el,i){return calc(el)})}else{r=calc(eles)}return r};LoadMaster.prototype._meta=function _meta(){this.eles=this.isWindowContainer?document.querySelectorAll(this.opts.items):this.container.querySelectorAll(this.opts.items);this.items=each(this.eles,function(el,i){return extend({index:i},calc(el))})};LoadMaster.prototype._scroll=function _scroll(e){var this$1=this;var t=0;var target=e.target;if(this.isWindowContainer){t=document.body.scrollTop}else{t=e.target.scrollTop}var isForward=t>this.lastTop;var absTop=Math.abs(t-this.lastTop);var isFast=absTop>this.opts.offset;if(isFast){var p=parseInt(absTop/this.opts.offset)+1;var ts=[];for(var i=0;i<p;i++){ts.push(this$1.lastTop+i*this$1.opts.offset*(isForward?1:-1))}ts.push(t);ts.map(function(t){this$1.opts.trigger.map(function(d){this$1[d](t,isForward,isFast)})})}else{this.opts.trigger.map(function(d){this$1[d](t,isForward,isFast)})}if(isForward){if(this.isWindowContainer){if(t+window.innerHeight>document.body.clientHeight-this.opts.offset){this.emit("end")}}else{if(t+target.offsetHeight>target.scrollHeight-this.opts.offset){this.emit("end")}}}this.lastTop=t};LoadMaster.prototype.bind=function bind(){var throttle=function(type,name,obj){obj=obj||window;var running=false;var func=function(e){if(running){return}running=true;setTimeout(function(){obj.dispatchEvent(new CustomEvent(name));running=false},20)};obj.addEventListener(type,func)};throttle("scroll","optimizedScroll",this.container);this.lastTop=0;this._scrollHandle=this._scroll.bind(this);this.container.addEventListener(this.opts.optimize?"optimizedScroll":"scroll",this._scrollHandle)};LoadMaster.prototype.above=function above(top,dir,isFast){var k=top-this.opts.offset;var t=k-this.opts.threshold;var eles=this.items.filter(function(d){return d.bottom>t&&d.bottom<k});if(eles.length){this.emit("above",eles.map(function(d){return d.el}),dir,top,eles,isFast)}};LoadMaster.prototype.curr=function curr(top,dir,isFast){var k=top+window.innerHeight;var eles=this.items.filter(function(d){return d.top>=top&&d.top<=k||d.bottom>=top&&d.bottom<=k});if(eles.length){this.emit("curr",eles.map(function(d){return d.el}),dir,top,eles,isFast)}};LoadMaster.prototype.below=function below(top,dir,isFast){var k=top+this.opts.offset;var t=k+this.opts.threshold;var eles=this.items.filter(function(d){return d.top>k&&d.top<t});if(eles.length){this.emit("below",eles.map(function(d){return d.el}),dir,top,eles,isFast)}};LoadMaster.prototype.refresh=function refresh(){this._meta()};LoadMaster.prototype.off=function off(){this.container.removeEventListener(this.opts.optimize?"optimizedScroll":"scroll",this._scrollHandle)};return LoadMaster}(EventEmitter);return LoadMaster});